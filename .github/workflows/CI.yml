name: Ecosystem
on: [push]
jobs:
  ecosystem:
    name: ${{ matrix.package }}
    strategy:
      matrix:
        package: ["postgresql-typed", "postgresql-caching", "postgresql-data-types", "postgresql-type-parsers", "postgresql-types-generator"]
        pgVersion: ["11", "12", "13", "14", "15", "latest"]
    uses: ./.github/workflows/package.yml
    with:
      package: ${{ matrix.package }}
      pgVersion: ${{ matrix.pgVersion }}
  coverage:
    name: Coverage
    needs: ecosystem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare environment
        uses: ./.github/actions/prepareEnvironment

      - name: Download coverage
        uses: actions/download-artifact@v3
        with:
          name: Coverage

      - name: Check badges
        run: pnpm badges:ci
  changesets:
    name: Publish
    needs: coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare environment
        uses: ./.github/actions/prepareEnvironment

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          publish: pnpm release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}