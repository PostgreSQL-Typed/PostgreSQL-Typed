name: Ecosystem
on: [push]
jobs:
  "PostgreSQL-Typed":
    name: PostgreSQL-Typed
    uses: ./.github/workflows/package.yml
    with:
      package: postgresql-typed
  "PostgreSQL-Caching":
    name: PostgreSQL-Caching
    uses: ./.github/workflows/package.yml
    with:
      package: postgresql-caching
  "PostgreSQL-Data-Types":
    name: PostgreSQL-Data-Types
    uses: ./.github/workflows/package.yml
    with:
      package: postgresql-data-types
  "PostgreSQL-Type-Parsers":
    name: PostgreSQL-Type-Parsers
    uses: ./.github/workflows/package.yml
    with:
      package: postgresql-type-parsers
  "PostgreSQL-Types-Generator":
    name: PostgreSQL-Types-Generator
    uses: ./.github/workflows/package.yml
    with:
      package: postgresql-types-generator
  coverage:
    name: Coverage
    needs: [PostgreSQL-Typed, PostgreSQL-Caching, PostgreSQL-Data-Types, PostgreSQL-Type-Parsers, PostgreSQL-Types-Generator]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare environment
        uses: ./.github/actions/prepareEnvironment

      - name: Download coverage
        uses: actions/download-artifact@v3
        with:
          name: Coverage

      - name: Check badges
        run: pnpm badges:ci
  changesets:
    name: Publish
    needs: coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare environment
        uses: ./.github/actions/prepareEnvironment

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          publish: pnpm release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}